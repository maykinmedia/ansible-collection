Deploy a Django-app on a Kubernetes cluster
===========================================

This role can be used to deploy components (which are Django projects following
the Maykin Media default project structure) on a kubernetes cluster.

Features:

* Fully parametrized with sane defaults
* App-namespace - deploy multiple apps in the same cluster/namespace
* Stateless or stateful apps
* Support for nginx virtual host entry
* Celery support (worker, beat, multiple queues, flower)
* Ingress support

Requirements
------------

* Access to the K8s cluster and the relevant namespace
* `kubectl` commandline tool should be installed on your local machine (Ansible control
  node) to validate/debug deployments
* `helm` commandline tool should be installed on your local machine (Ansible control
  node) to deploy some components
* PostgreSQL (or other relevant database engine) must be installed and configured

This role plays well with:

* `geerlingguy.postgresql` for DB provisioning

Role Variables
--------------

See `defaults/main.yml` for all available variables with their default values and
functionality.

The variables below are best specified explicitly or changed because the defaults
lead to an insecure deployment:

* `django_app_k8s_name_prefix` - used to namespace each application.
* `django_app_k8s_domain` - domain where the app is deployed/(publicly) accessible
* `django_app_k8s_secret_key` - generate one using
  https://miniwebtool.com/django-secret-key-generator/ and keep it secret
* `django_app_k8s_sentry_dsn` - highly recommended to create a Sentry project for
  error monitoring.
* `django_app_k8s_package_name` - python package name of the app, if different from
  the name prefix.

Database credentials:

* `django_app_k8s_db_host` - hostname of the database to connect to.
* `django_app_k8s_db_name` - name of the database to connect to
* `django_app_k8s_db_user` - user to use for db connection
* `django_app_k8s_db_password` - password to use for db connection

The default variables assume that a database is running on localhost, which should
never be the case. It's highly recommended to use a database server from your cloud
provider.

Ingress:

* `django_app_k8s_tls` - indicates whether or not TLS should be configured for the
  application. Certificates are generated by the cluster or you have to provision the
  secret upfront.
* `django_app_k8s_ingress` - whether to explose the service via an ingress or not.
* `django_app_k8s_ingress_annotations` - the relevant annotations for the ingress class
  you're using. Not all clusters use the same ingress solution.
* `django_app_k8s_add_nginx` - whether to deploy an nginx container as reverse proxy
  between the ingress and the app. Enable this if you're making use of private media
  which requires nginx `X-Accel-Redirect`.

Container image:

* `django_app_k8s_version` - point to a pinned image tag. Avoid using `latest`,
  unless you want to _always_ pull container images while deploying.
* `django_app_k8s_sha256` - better alternative for pinned image versions, as digests
  are immutable while image tags are not. 
* `django_app_k8s_image_name` - image name in the format `maykinmedia/<name>` for the
  app. Defaults to `maykinmedia/<prefix>`.


High availability settings:

* `django_app_k8s_replicas` - number of backend containers to run (web). Increasing
  this number consumes more resources but allows you to handle more concurrent requests.
* `django_app_k8s_celery_workers[].replicas` - number of replicas for a given celery
  worker

Celery integration

* `django_app_k8s_flower_user` and `django_app_k8s_flower_password` are sensitive
  credentials, giving insight into the application internals and possibly data as task
  arguments.

**Facts set**

This role sets some facts that can be used in subsequent roles:

* `django_app_k8s_image` the resolved image 'name'. Combines image registry, image name
  and tag/sha256.

Dependencies
------------

* `community.k8s` collection to manage k8s infrastructure

Example Playbook
----------------

**Standard backend deploy - Django only**

```yaml
- name: Simple Django playbook
  hosts: all

  collections:
    - maykinmedia.commonground

  vars:
    django_app_k8s_name_prefix: example1
    django_app_k8s_domain: example1.example.com
    django_app_k8s_secret_key: '*chbr!n^(s9(13(9j3kkodb4-ptn36)2q-a&2u!c6!tu)^53vr'
    django_app_k8s_package_name: example1
    django_app_k8s_db_name: example1
    django_app_k8s_db_username: example1
    django_app_k8s_db_password: example1
    django_app_k8s_version: latest
    django_app_k8s_image_name: scrumteamzgw/bptl
    django_app_k8s_replicas: 1

  roles:
    - role: django_app_k8s
```

**Celery enabled deploy - Django backend + celery**

```yaml
- name: Django playbook with Celery, Beat and Flower
  hosts: all

  collections:
    - maykinmedia.commonground

  vars:
    django_app_k8s_name_prefix: example2
    django_app_k8s_domain: example2.maykinmedia.nl
    django_app_k8s_secret_key: '*chbr!n^(s9(13(9j3kkodb4-ptn36)2q-a&2u!c6!tu)^53vr'
    django_app_k8s_package_name: example2
    django_app_k8s_db_name: example2
    django_app_k8s_db_username: example2
    django_app_k8s_db_password: example2
    django_app_k8s_version: latest
    django_app_k8s_image_name: scrumteamzgw/bptl
    django_app_k8s_replicas: 1

    django_app_k8s_use_celery: true
    django_app_k8s_use_celery_beat: true

  roles:
    - role: django_app_k8s
```

License
-------

UNLICENSED

Author Information
------------------

[Maykin Media](https://www.maykinmedia.nl/en/) provides hassle-free, custom-made
websites and webapps for clients.

We pride ourselves in solid, well-tested applications and contributing back to the Open
Source community. We provide consultancy, development and support & hosting.

[default-project]: https://bitbucket.org/maykinmedia/default-project
