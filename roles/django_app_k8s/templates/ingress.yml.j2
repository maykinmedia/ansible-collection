---

kind: Ingress
apiVersion: extensions/v1beta1
metadata:
  labels:
    app.kubernetes.io/name: traefik
    app.kubernetes.io/instance: "{{ django_app_k8s_instance }}"
    app.kubernetes.io/version: "{{ django_app_k8s_version }}"
    app.kubernetes.io/component: backend
    app.kubernetes.io/part-of: "{{ django_app_k8s_group }}"
    app.kubernetes.io/managed-by: Ansible
  annotations:
    kubernetes.io/ingress.class: traefik-public
    traefik.ingress.kubernetes.io/rule-type: PathPrefixStrip
spec:
{% if django_app_k8s_tls %}
  tls:
    - hosts:
        - "{{ django_app_k8s_domain }}"
      secretName: "{{ django_app_k8s_name_prefix }}-tls-secrets"
{% endif %}
  rules:
  - host: "{{ django_app_k8s_domain }}"
    http:
      paths:
      - path: /
        backend:
{% if django_app_k8s_add_nginx %}
          serviceName: {{ django_app_k8s_name_prefix }}-nginx
          servicePort: 80
{% else %}
          serviceName: {{ django_app_k8s_name_prefix }}
          servicePort: 8000
{% endif %}

{% if django_app_k8s_use_celery %}
      - path: /_flower
        backend:
          serviceName: {{ django_app_k8s_name_prefix }}-monitoring
          servicePort: 5555
{% endif %}

{% for extra_route in django_app_k8s_extra_ingress_paths %}
      - {{ extra_route }}
{% endfor %}
